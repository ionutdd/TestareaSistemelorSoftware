# Testing Report: ChatGPT 3.5 vs. Our Implementation

## Overview
This report evaluates the security tests generated by **ChatGPT 3.5** for the `LeaveRoom` method in the `FMInatorul` .NET 6.0 application, which facilitates quiz generation from PDFs and a Kahoot-style game for students. The tests focus on two scenarios:
1. **User leaves a room successfully**: The user is a participant in the room and should leave with a success response.
2. **User tries to leave a room they are not in**: The user should receive an error response when attempting to leave a non-existent room.

We have provided our own test implementations, which were validated successfully using xUnit. This report compares ChatGPT’s generated tests against the our’s and identifies errors in ChatGPT’s output.

**Conversation Link**: [ChatGPT Conversation](https://chatgpt.com/share/680f494d-b038-800d-b0ec-5887d0a3a71a)

## Test Scenarios
The `LeaveRoom` method in `RoomsController` handles a user leaving a game room, with the following logic:
- Validates the logged-in user via `_userManager.GetUserId`.
- Checks for a student profile, room existence (by `code`), and participant status.
- Removes the participant from the room, deletes the room if it becomes empty, and notifies other users via SignalR.
- Returns JSON responses, such as:
  - `{ success: true, message: "You have left the room." }` (success).
  - `{ success: false, message: "Room not found" }` (room does not exist).
  - `{ success: false, message: "You are not in this room" }` (user not a participant).

The two test scenarios are:
1. **Successful Leave**: The user is in the room, leaves successfully, and the room is removed if empty.
2. **User Not in Room**: The user attempts to leave a non-existent room, expecting `{ success: false, message: "Room not found" }`.

## Errors in ChatGPT 3.5’s Generated Tests

### 1. Incorrect Error Message for “User Not in Room” Scenario
- **ChatGPT’s Error**:
  - ChatGPT assumed the error message for a user not in the room is `"You are not in this room"`, based on the `LeaveRoom` method’s logic:
    ```csharp
    if (participant == null)
    {
        return Json(new { success = false, message = "You are not in this room" });
    }
    ```
  - We specified the expected message as `"Room not found"`, which corresponds to:
    ```csharp
    if (room == null)
    {
        return Json(new { success = false, message = "Room not found" });
    }
    ```
  - ChatGPT misunderstood the our requirement, testing the case where the participant is not found instead of the room not existing.

- **Impact**:
  - The test (`LeaveRoom_UserNotInRoom_ReturnsErrorMessage`) does not meet the our requirement, validating the wrong error case.
  - This misalignment could lead to false confidence in test coverage, missing the intended scenario.

- **Correct Approach**:
  - Simulate a non-existent room by returning `null` for the room lookup:
    ```csharp
    mockContext.Setup(c => c.Rooms.FirstOrDefaultAsync(r => r.Code == roomCode, default))
        .ReturnsAsync((Room)null);
    ```

### 2. Incomplete Mocking for SignalR in “User Not in Room” Test
- **ChatGPT’s Error**:
  - In `LeaveRoom_UserNotInRoom_ReturnsErrorMessage`, ChatGPT mocked `IHubContext<RoomHub>` but did not configure the SignalR call (`SendAsync`), which is unnecessary since the method returns early if the participant is not found.
  - While this doesn’t cause a test failure, it’s redundant and could confuse readers about the method’s behavior.

- **Impact**:
  - Unnecessary mocking adds complexity without value, potentially slowing test setup.

- **Correct Approach**:
  - Omit SignalR mocking for this test, as the method does not reach the SignalR notification:
    ```csharp
    var mockRoomHubContext = new Mock<IHubContext<RoomHub>>(); // Sufficient
    ```

### 3. Lack of Database Context Setup
- **ChatGPT’s Error**:
  - ChatGPT used a fully mocked `ApplicationDbContext` with Moq, simulating database queries (e.g., `Students`, `Rooms`, `Participants`) without an actual database.
  - Our tests use an **in-memory SQLite database** (`_mockDbContext`), seeding it with realistic data (e.g., `Facultate`, `Student`, `Room`, `Participant`).
  - ChatGPT’s approach is simpler but less realistic, missing edge cases like database constraints or relationships (e.g., foreign keys between `Room` and `Materie`).

- **Impact**:
  - ChatGPT’s tests are unit tests, isolating the controller but not testing database interactions, which are critical for `LeaveRoom` (e.g., `_context.SaveChangesAsync()`).
  - This could miss bugs in Entity Framework or database configuration.

- **Correct Approach**:
  - Use an in-memory database (like SQLite) to simulate real database behavior, as we did:
    ```csharp
    await _mockDbContext.Database.OpenConnectionAsync();
    await _mockDbContext.Database.EnsureCreatedAsync();
    ```

### 4. Missing Comprehensive Setup for Related Entities
- **ChatGPT’s Error**:
  - ChatGPT’s tests only mocked minimal entities (`Student`, `Room`, `Participant`) without related data like `Facultate`, `Materie`, or `IntrebariRasp`, which we included to reflect the application’s domain.
  - The `LeaveRoom` method itself doesn’t directly use these entities, but the database schema (e.g., foreign keys) may require them for valid seeding.

- **Impact**:
  - ChatGPT’s tests fail in a real database context due to missing related data, reducing test reliability.

- **Correct Approach**:
  - Seed related entities to ensure database integrity, as we did:
    ```csharp
    var facultate = new Facultate { Id = 1, nume = "Test Facultate" };
    var materie = new Materie { Id = 1, nume = "Mathematics", FacultateID = facultate.Id };
    ```

### 5. Oversimplified Assertion
- **ChatGPT’s Error**:
  - ChatGPT’s assertions check only `success` and `message` using `dynamic` typing:
    ```csharp
    Assert.False((bool)json.success);
    Assert.Equal("You are not in this room", (string)json.message);
    ```
  - This is less robust and harder to maintain than strongly-typed assertions.

- **Impact**:
  - Less precise assertions may miss subtle response issues.
  - `dynamic` typing can lead to runtime errors if the JSON structure changes.

- **Correct Approach**:
  - Use strongly-typed assertions with JSON serialization, as we did:
    ```csharp
    var jsonResult = Assert.IsType<JsonResult>(result);
    var expectedResult = new { success = false, message = "Room not found" };
    Assert.Equal(JsonSerializer.Serialize(expectedResult), JsonSerializer.Serialize(jsonResult.Value));
    ```

## Comparison: ChatGPT 3.5 vs. Our Implementation

| **Aspect** | **ChatGPT 3.5** | **Our Implementation** | **Analysis** |
|------------|-----------------|-------------------------|--------------|
| **Test Type** | Unit test with fully mocked `ApplicationDbContext` using Moq. | Integration test using in-memory SQLite database (`_mockDbContext`). | Our approach is more realistic, testing database interactions and schema constraints, which are critical for `LeaveRoom`. ChatGPT’s unit tests are simpler but miss database-related bugs. |
| **Error Message for “User Not in Room”** | Tested for `"You are not in this room"` (participant not found). | Tested for `"Room not found"` (room does not exist). | ChatGPT misunderstood the our requirement, testing the wrong error case. Our test correctly aligns with the specified scenario. |
| **Database Setup** | Mocked queries without a real database. | Used SQLite in-memory database with full schema seeding. | Our approach ensures database integrity and tests EF Core behavior. ChatGPT’s mocks are less robust for this context. |
| **Entity Seeding** | Minimal entities (`Student`, `Room`, `Participant`). | Comprehensive seeding (`Facultate`, `Materie`, `IntrebariRasp`, etc.). | Our seeding reflects the application’s domain, ensuring valid database state. ChatGPT’s minimal setup risks schema issues. |
| **SignalR Mocking** | Included unnecessary SignalR mock in “User Not in Room” test. | Correctly mocked SignalR only for “Successful Leave” test. | Our approach avoids redundant mocking, improving clarity and performance. |
| **Assertions** | Used `dynamic` typing for JSON assertions. | Used strongly-typed JSON serialization comparisons. | Our assertions are more robust and maintainable. ChatGPT’s `dynamic` approach is error-prone. |
| **Test Setup Reusability** | Repeated setup code across tests; suggested a shared helper but didn’t implement it. | Repeated setup code but included comprehensive seeding for realism. | Both could benefit from a shared `Arrange` helper to reduce duplication. Our setup is more thorough. |
| **Mocking Framework** | Used Moq with a generic `MockUserManager` helper. | Used Moq with specific `_mockUserManager` and `_mockRoleManager` setups. | Both approaches are valid, but our setup is made for the controller’s dependencies, including `RoleManager`. |


